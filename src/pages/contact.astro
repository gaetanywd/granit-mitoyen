---
// Page Contact : formulaire Formspree en priorité ; si envoi échoue, affichage de l'email en secours.
// Sans PUBLIC_FORMSPREE_ENDPOINT : affichage direct de l'email dans la liste.
import Layout from '../layouts/Layout.astro';
import { contactLinks, FALLBACK_EMAIL } from '../data/contact';
import { t, type Locale } from '../i18n/dict';

const currentLocale = (Astro.currentLocale ?? 'fr') as Locale;
const pageTitle = `${t(currentLocale, 'contact.title')} - ${t(currentLocale, 'layout.siteTitle')}`;

const formspreeEndpoint = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT as string | undefined;
const hasForm = Boolean(formspreeEndpoint?.startsWith('http'));
---

<Layout title={pageTitle}>
  <h1 class="text-3xl font-bold mb-6">
    {t(currentLocale, 'contact.title')}
  </h1>

  <!-- Formulaire Formspree (affiché seulement si l'endpoint est configuré) -->
  {hasForm && (
    <section class="mb-8 max-w-xl">
      <form
        id="contact-form"
        class="space-y-4"
        aria-label="Formulaire de contact"
      >
        <input type="hidden" name="_subject" value="Contact depuis le site Granit Mitoyen" />
        <div>
          <label for="contact-name" class="block text-sm font-medium text-gray-700 mb-1">
            {t(currentLocale, 'contact.formLabel.name')}
          </label>
          <input
            type="text"
            id="contact-name"
            name="name"
            class="w-full rounded border border-gray-300 px-3 py-2 text-gray-900"
          />
        </div>
        <div>
          <label for="contact-email" class="block text-sm font-medium text-gray-700 mb-1">
            {t(currentLocale, 'contact.formLabel.email')} <span class="text-red-600">*</span>
          </label>
          <input
            type="email"
            id="contact-email"
            name="_replyto"
            required
            class="w-full rounded border border-gray-300 px-3 py-2 text-gray-900"
          />
        </div>
        <div>
          <label for="contact-message" class="block text-sm font-medium text-gray-700 mb-1">
            {t(currentLocale, 'contact.formLabel.message')} <span class="text-red-600">*</span>
          </label>
          <textarea
            id="contact-message"
            name="message"
            required
            rows="5"
            class="w-full rounded border border-gray-300 px-3 py-2 text-gray-900"
          />
        </div>
        <button
          type="submit"
          id="contact-submit"
          class="rounded bg-gray-800 px-4 py-2 text-white hover:bg-gray-700 disabled:opacity-50"
        >
          {t(currentLocale, 'contact.formSubmit')}
        </button>
      </form>

      <!-- Message de succès (caché au chargement) -->
      <p id="contact-success" class="hidden mt-4 text-green-700 font-medium" role="status">
        {t(currentLocale, 'contact.formSuccess')}
      </p>

      <!-- Message d'échec + email de secours (caché au chargement) -->
      <div id="contact-failure" class="hidden mt-4 text-gray-700">
        <p class="font-medium mb-2">{t(currentLocale, 'contact.formFailure')}</p>
        <a
          id="contact-fallback-email"
          href={`mailto:${FALLBACK_EMAIL}`}
          class="text-blue-600 hover:text-blue-800 hover:underline"
        >
          {FALLBACK_EMAIL}
        </a>
      </div>
    </section>
  )}

  <!-- Si pas de Formspree configuré : afficher l'email en premier dans la liste -->
  {!hasForm && (
    <p class="mb-4 max-w-xl">
      {t(currentLocale, 'contact.email')}
      {' — '}
      <a href={`mailto:${FALLBACK_EMAIL}`} class="text-blue-600 hover:text-blue-800 hover:underline">
        {FALLBACK_EMAIL}
      </a>
    </p>
  )}

  <!-- Liens réseaux (toujours affichés) -->
  <ul class="space-y-3 max-w-xl">
    {contactLinks.map((link) => (
      <li>
        <a
          href={link.url}
          target="_blank"
          rel="noopener noreferrer"
          class="text-blue-600 hover:text-blue-800 hover:underline"
        >
          {t(currentLocale, link.labelKey)}
        </a>
      </li>
    ))}
  </ul>
</Layout>

{hasForm && (
  <script define:vars={{ formspreeEndpoint }}>
    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('contact-submit');
    const successEl = document.getElementById('contact-success');
    const failureEl = document.getElementById('contact-failure');

    if (form && submitBtn && successEl && failureEl && formspreeEndpoint) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;

        const formData = new FormData(form);
        const body = JSON.stringify({
          name: formData.get('name') || '',
          _replyto: formData.get('_replyto') || '',
          message: formData.get('message') || '',
        });

        try {
          const res = await fetch(formspreeEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body,
          });
          if (res.ok) {
            form.classList.add('hidden');
            successEl.classList.remove('hidden');
          } else {
            failureEl.classList.remove('hidden');
          }
        } catch {
          failureEl.classList.remove('hidden');
        }
        submitBtn.disabled = false;
      });
    }
  </script>
)}
